stages:         
  - build
  - test

image: docker:19.03.12
variables:
 DOCKER_HOST: tcp://docker:2375/
 DOCKER_TLS_CERTDIR: ""
 REGISTRY_HOSTNAME: gcr.io/pintu-sre
services:
 - docker:19.03.12-dind

test-nodejs:
  stage: test
  script:
   - npm test ./nodejs

test-golang:
  stage: test
  script:
   - go test ./golang

build-nodejs:       
  stage: build
  before_script:
   - docker info
   - echo "$SERVICE_ACCOUNT_KEY" > service-account.json
   - docker login -u _json_key --password-stdin https://gcr.io < service-account.json
  script:
   - docker build --tag $REGISTRY_HOSTNAME/nodejs-taskapp:$CI_COMMIT_SHORT_SHA ./nodejs
   - docker push $REGISTRY_HOSTNAME/nodejs-taskapp:$CI_COMMIT_SHORT_SH

