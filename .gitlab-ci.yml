image: node:16-alpine
stages:         
  - build
  - test

variables:
 REGISTRY_HOSTNAME: gcr.io/pintu-sre

test-nodejs:
  stage: test
  script:
   - npm test ./nodejs

test-golang:
  stage: test
  script:
   - go test ./golang

build-nodejs:
  image: docker:latest         
  stage: build
  services:
    - docker:dind
  before_script:
   - docker info
   - echo "$SERVICE_ACCOUNT_KEY" > service-account.json
   - docker login -u _json_key --password-stdin https://gcr.io < service-account.json
  script:
   - docker build --tag $REGISTRY_HOSTNAME/nodejs-taskapp:$CI_COMMIT_SHORT_SHA ./nodejs
   - docker push $REGISTRY_HOSTNAME/nodejs-taskapp:$CI_COMMIT_SHORT_SHA

